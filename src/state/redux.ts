import { combineReducers, createStore } from 'redux'
import { KernelAccountState, KernelResult, KernelLoadingProgress } from '@dcl/kernel-interface'
import { kernelReducer, sessionReducer, rendererReducer, errorReducer } from './reducers'
import { composeWithDevTools } from 'redux-devtools-extension'

export type KernelState = {
  ready: boolean
  kernel: KernelResult | null
}

export type RendererState = {
  ready: boolean
  version: string
  visible: boolean
  loading: KernelLoadingProgress | null
}

export type SessionState = {
  // It is important that this ID is autogenerated in every user session (reload)
  // and it _never_ changes during the session
  sessionId: string
  kernelState: KernelAccountState | null
}

export type ErrorState = {
  error: {
    type: string | ErrorType
    details: string
  } | null
}

export enum ErrorType {
  LOADING = 'loading',
  FATAL = 'fatal',
  COMMS = 'comms',
  NEW_LOGIN = 'newlogin',
  NOT_MOBILE = 'nomobile',
  NOT_SUPPORTED = 'notsupported',
  NET_MISMATCH = 'networkmismatch',
  AVATAR_ERROR = 'avatarerror',
  METAMASK_LOCKED = 'METAMASK_LOCKED'
}

export type StoreType = {
  kernel: KernelState
  renderer: RendererState
  session: SessionState
  error: ErrorState
}

const reducers = combineReducers<StoreType>({
  kernel: kernelReducer,
  session: sessionReducer,
  renderer: rendererReducer,
  error: errorReducer
})

const middleware: typeof composeWithDevTools =
  process.env.NODE_ENV !== 'production' ? composeWithDevTools : (x: any) => x

export const store = createStore(reducers, {}, middleware())
